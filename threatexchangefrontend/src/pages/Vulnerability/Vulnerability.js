import React, { useEffect, useState } from 'react'
import theme from '../../theme'
import {Header, BackButton} from '../../components'
import classes from '../../styles/Dashboard.module.css'
import styles from './Vulnerability.module.css'
import { GetCve } from '../../api/Cve.api'
import { Loader } from '../../components'
import { useLocation, useHistory } from 'react-router-dom'
import { FiExternalLink } from 'react-icons/fi'

export default function Vulnerability() {
    const [loading, setLoading] = useState(true)
    const [v, setV] = useState(2)
    const [data, setData] = useState(null)
    const location = useLocation()
    const history = useHistory()
    useEffect(()=>{
        if(data===null){
            getData()
        }
    },[location.pathname])

    const getData = async()=>{
        setLoading(true)
        let id = location.pathname.substring(location.pathname.lastIndexOf('/')+1)
        const result = await GetCve({cve:id})
        if(result.status===200 && !result.data?.message){
            setData(result.data)
            console.log(result.data)
        }
        else{
            history.replace('/not-found')
        }
        setLoading(false)
    }

    return (
        <div style={{backgroundColor:theme.colors.dark,minHeight:'100vh'}}>
            <Header/>
            <div style={{paddingBottom:20,paddingTop:100, paddingInline:20}}>
                <BackButton/>
            </div>
            {loading?
            <div><Loader size={45}/></div>
                :
            <div className={classes.divide}>
                <div className={classes.left}>
                    <text style={{fontWeight:'bold',color:theme.colors.whiteoff,fontSize:22}}>{data?.id}</text>
                    <div className={classes.border}>
                       <text style={{color:theme.colors.whiteoff,fontSize:13}}>{data?.summary}</text>
                    </div>
                    <div className={classes.border}>
                        <div className={styles.cvsss}>
                            <button onClick={()=>setV(3)} className={`${styles.cvButton} ${v===3? styles.activeCvButton:null}`}>CVSS v.3.0</button>
                            <button onClick={()=>setV(2)} className={`${styles.cvButton} ${v===2? styles.activeCvButton:null}`}>CVSS v.2.0</button>
                        </div>
                        <>
                        {data.raw_nvd_data.impact.baseMetricV3?.cvssV3 && data.raw_nvd_data.impact.baseMetricV2?.cvssV2 ?
                        <>
                        {v==3?
                            <>
                            <div className={classes.vulContent}>
                                <div className={`${classes.MainBox} ${classes.mainContent}`}>
                                    <div style={{color:'white',padding:10}}>
                                        <text style={{fontWeight:'bold',fontSize:30}}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3?.baseScore}/10</text><br/>
                                        <text>CVSS v3.0 : {data.raw_nvd_data.impact.baseMetricV3.cvssV3.baseSeverity}</text>
                                    </div>
                                    <div onClick={()=>window.open('https://www.first.org/cvss/specification-document',"_blank")} className={styles.viewLagend}>
                                        V3 Legend
                                    </div>
                                </div>
                                <div className={` ${classes.mainContent}`}>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Attack Vector</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.attackVector}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Attack Complexity</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.attackComplexity}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Privileges Required</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.privilegesRequired}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>User Interaction</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.userInteraction}</text>
                                    </div>
                                </div>
                                <div className={` ${classes.mainContent}`}>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Confidentiality Impact</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.confidentialityImpact}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Availability Impact</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.availabilityImpact}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Integrity Impact</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.integrityImpact}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Scope</text>
                                        <text className={styles.metricItemTag}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.scope}</text>
                                    </div>
                                </div>
                            </div>
                            <div style={{fontSize:14,marginTop:15,color:theme.colors.whiteoff,marginLeft:20,fontWeight:'600'}}>
                                Vector : <span style={{fontWeight:'normal'}}>{data.raw_nvd_data.impact.baseMetricV3.cvssV3.vectorString}</span><br/><br/>
                                Exploitability : <span style={{fontWeight:'normal'}}>{data.raw_nvd_data.impact.baseMetricV3.exploitabilityScore}</span> / Impact : <span style={{fontWeight:'normal'}}>{data.raw_nvd_data.impact.baseMetricV3.impactScore}</span>
                            </div>
                            </>
                            :
                            <>
                            <div className={classes.vulContent}>
                                <div className={`${classes.MainBox} ${classes.mainContent}`}>
                                    <div style={{color:'white',padding:10}}>
                                        <text style={{fontWeight:'bold',fontSize:30}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2?.baseScore}/10</text><br/>
                                        <text>CVSS v2.0 : {data.raw_nvd_data.impact.baseMetricV2.severity}</text>
                                    </div>
                                    <div onClick={()=>window.open('https://www.first.org/cvss/v2/guide',"_blank")} className={styles.viewLagend}>
                                        V2 Legend
                                    </div>
                                </div>
                                <div className={` ${classes.mainContent}`}>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Access Vector</text>
                                        <text style={{color:"white",fontSize:12,backgroundColor:theme.colors.footer,padding:3}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2.accessVector}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Access Complexity</text>
                                        <text style={{color:"white",fontSize:12,backgroundColor:theme.colors.footer,padding:3}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2.accessComplexity}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Authentication</text>
                                        <text style={{color:"white",fontSize:12,backgroundColor:theme.colors.footer,padding:3}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2.authentication}</text>
                                    </div>
                                </div>
                                <div className={` ${classes.mainContent}`}>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Confidentiality Impact</text>
                                        <text style={{color:"white",fontSize:12,backgroundColor:theme.colors.footer,padding:3}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2.confidentialityImpact}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Integrity Impact</text>
                                        <text style={{color:"white",fontSize:12,backgroundColor:theme.colors.footer,padding:3}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2.integrityImpact}</text>
                                    </div>
                                    <div className={classes.labelBox}>
                                        <text style={{color:'white',fontSize:15}}>Availability Impact</text>
                                        <text style={{color:"white",fontSize:12,backgroundColor:theme.colors.footer,padding:3}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2.availabilityImpact}</text>
                                    </div>
                                </div>
                            </div>
                            <div style={{fontSize:14,marginTop:15,color:theme.colors.whiteoff,marginLeft:20,fontWeight:'600'}}>
                                Vector : <span style={{fontWeight:'normal'}}>{data.raw_nvd_data.impact.baseMetricV2.cvssV2.vectorString}</span><br/><br/>
                                Exploitability : <span style={{fontWeight:'normal'}}>{data.raw_nvd_data.impact.baseMetricV2.exploitabilityScore}</span> / Impact : <span style={{fontWeight:'normal'}}>{data.raw_nvd_data.impact.baseMetricV2.impactScore}</span>
                            </div>
                            </>
                        }
                        </>
                        :
                        <h5 style={{color:'white'}}>No CVE found !</h5>
                        }
                        </>
                    </div>
                    <div className={classes.border}>
                        <text style={{fontSize:18,color:theme.colors.whiteoff}}>Reference</text>
                        <table style={{width:'100%',color:theme.colors.whiteoff,wordBreak:'break-all'}}>
                            <tr>
                                <th>Link</th>
                                <th>Resources</th>
                            </tr>
                            {data?.raw_nvd_data?.cve?.references?.reference_data.map((data,index)=>{
                                return(
                                    <tr key={index}>
                                        <td><a style={{fontSize:14}} className={styles.link} href={data.url} >{data.name==null? data.name : data.url}</a></td>
                                        <td style={{display:'flex',flexDirection:'row',flexWrap:'wrap'}}>
                                            {data?.tags.map((value,index)=>{
                                                return (
                                                    <div key={index} className={styles.tag}>{value}</div>
                                                )
                                            })}
                                        </td>
                                    </tr>
                                )
                            })}
                            
                        </table>
                    </div>
                    <div className={classes.border}>
                        <text style={{fontSize:18,color:theme.colors.whiteoff}}>Configurations</text>
                        <table style={{padding:10,color:theme.colors.whiteoff,width:'100%'}}>
                            {data.raw_nvd_data.configurations?.nodes?.map((data,index)=>{
                                return(
                                    <>
                                        <tr>
                                            Configuration ({index+1})
                                        </tr><br/>
                                        {data?.cpe_match?.map((data,index)=>{
                                            return(
                                                <tr key={index} style={{backgroundColor:theme.colors.footer,borderRadius:8}}>
                                                    <td style={{padding:8, wordBreak:'break-all'}}>{data?.cpe23Uri}</td>
                                                    {/* <td>{Array(data?.cpe_name).toString()}</td> */}
                                                </tr>
                                            )
                                        })}
                                        <br/>
                                    </>
                                )
                            })}
                        </table>
                    </div>
                </div>
                <div className={classes.right}>
                    <div style={{marginTop:40}} className={classes.border}>
                        <text style={{fontSize:18,color:theme.colors.whiteoff}}>Information</text><br/><br/>
                        <text style={{fontSize:12,color:theme.colors.gray,fontWeight:'bold'}}>Published : {new Date(data?.raw_nvd_data?.publishedDate).toLocaleString()}</text><br/><br/>
                        <text style={{fontSize:12,color:theme.colors.gray,fontWeight:'bold'}}>Updated : {new Date(data?.raw_nvd_data?.lastModifiedDate).toLocaleString()}</text><br/><br/>
                        <text style={{fontSize:12,color:theme.colors.gray,fontWeight:'bold'}}><FiExternalLink color='white' size={12}/> NVD link : <a className={styles.link} target='_blank' href={`https://nvd.nist.gov/vuln/detail/${data.id}`}>{data.id}</a></text><br/><br/>
                        <text style={{fontSize:12,color:theme.colors.gray,fontWeight:'bold'}}><FiExternalLink color='white' size={12}/> Mitre link : <a className={styles.link} target='_blank' href={`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${data.id}`}>{data.id}</a></text><br/><br/>
                        <text style={{fontSize:12,color:theme.colors.gray,fontWeight:'bold'}}>JSON object : View</text><br/><br/>
                    </div>
                </div>
            </div>
            }
        </div>
    )
}
